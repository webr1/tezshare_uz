# Определение апстрима (наш Django контейнер)
upstream tezshare_app {
    server web:8000;
}

# Редирект с HTTP на HTTPS (когда получим сертификаты)
server {
    listen 80;
    server_name tezshare.uz www.tezshare.uz;

    # Место для проверки Certbot
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# Основной сервер HTTPS
server {
    listen 443 ssl;
    server_name tezsend.uz www.tezsend.uz;

    # Пути к сертификатам Let's Encrypt
    ssl_certificate /etc/letsencrypt/live/tezshare.uz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tezshare.uz/privkey.pem;

    # Оптимизация SSL
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Лимит на размер загружаемого файла (согласно твоим планам)
    client_max_body_size 500M;

    # Защищенная папка медиа
    location /media/ {
        # Параметр internal запрещает прямой доступ извне
        internal; 
        alias /app/media/;
    }

    # Проксирование всех остальных запросов на Django
    location / {
        proxy_pass http://tezshare_app;
        # ... остальные настройки прокси ...
}

    # Статические файлы (CSS, JS, изображения)
    location /static/ {
        alias /app/static/;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # Медиа-файлы (загрузки пользователей TezShare)
    location /media/ {
        alias /app/media/;
        expires 1d;
        add_header Content-Disposition "attachment"; # Принудительное скачивание
    }

    # Проксирование запросов к Django (Gunicorn)
    location / {
        proxy_pass http://tezshare_app;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;
        proxy_redirect off;
        
        # Тайм-ауты для больших файлов
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
    }
}